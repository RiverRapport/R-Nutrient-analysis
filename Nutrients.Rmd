---
title: "Nutrients"
author: "Erin Smith"
date: "2023-02-28"
output:
  pdf_document: default
  html_document: default
  word_document: default
---
```{r, echo = F}
library(knitr)
opts_chunk$set(tidy.opts=list(width.cutoff=80),tidy=TRUE)
```
#River Rapport - Nutrients - Technical Report

###Load packages and prep data
Packages required
```{r Load Packages}
library(Kendall)
library(corrplot)
library(trend)
library(segmented)
library(modifiedmk)
library(ggplot2)
library(ggpubr)
library(gridExtra)
library(grid)
library(EnvStats)
library(lubridate)
library(lmtest)
library(dplyr)
library(tidyr)
library(openair)
library(mgcv)
library(mgcViz)
library(gratia)
library(itsadug)
library(FSA)
library(ggsignif)
library(viridis)
library(RColorBrewer)
library(forecast)
library(gganimate)
library(gifski)
library(nlme)
library(ggmap)
library(Hmisc)
```

Load dataframes and format data
```{r Load and prepare data}
GN<-read.csv("Gov_nut_data_depth.csv",header=TRUE)
head(GN)

AD<-read.csv("Ac_nut_data_depth.csv",header=TRUE)
head(AD)

clim<-read.csv("Monthly_climate_USLR_1960.2022.csv",header=TRUE)
clim$River_section <- factor(clim$River_section , levels=c("TI", "BR", "LSL", "CA","LSF"))
head(clim)
```
Combine data sets
```{r Combine dataframes}
Ac_gov<-rbind(GN,AD)
Ac_gov$Sample_date<-as.Date(Ac_gov$Sample_date,"%Y-%m-%d")
Ac_gov$River_section <- factor(Ac_gov$River_section , levels=c("TI", "BR", "LSL", "CA","LSF"))
Ac_gov$Site<-factor(Ac_gov$Site)
Ac_gov$Data_source<-factor(Ac_gov$Data_source)
Ac_gov$year <- year(ymd(Ac_gov$Sample_date))
Ac_gov$month <- month(ymd(Ac_gov$Sample_date)) 
Ac_gov$day <- day(ymd(Ac_gov$Sample_date))
Ac_gov$DOY<-yday(Ac_gov$Sample_date)
Ac_gov$NS_MC<-factor(Ac_gov$NS_MC)
Ac_gov$NP<-with(Ac_gov,TN/TP)

#add climate data
Nut_precip<-merge(x=Ac_gov,y=clim,by=c("River_section","year","month"),all=FALSE)
#add season to df
Nut_precip<-Nut_precip%>%
  mutate(season=case_when(
    month > 2 & month < 6 ~ "spring",
    month > 5 & month < 9 ~ "summer",
    month > 8 & month < 12 ~ "fall",
    month > 11 | month < 3 ~ "winter"
  ),
  cont_year=decimal_date(Sample_date))
head(Nut_precip)
write.csv(Nut_precip,"USLR_nutrients.csv",row.names = FALSE)

Meta_data<-Nut_precip%>%
  group_by(Data_source)%>%
  summarise(Yearmin=min(year),
            Yearmax=max(year),
            RS=unique(River_section))

write.csv(Meta_data,"RR_Nutrients_Metadata.csv",row.names = FALSE)

GLIP_USGS<-subset(Nut_precip,Data_source=="OMECP_GLIP"|Data_source=="USGS-NY")

GLIP_Ann<-GLIP%>%
  group_by(year,River_section)%>%
  summarise(TP.mg.L=mean(TP,na.rm=T))%>%
  pivot_wider(names_from = River_section,values_from = TP.mg.L)

write.csv(GLIP_Ann,"TP_TI.BR.CA_Annual.csv",row.names = F)
```

```{r Correlation matrix}
res<-cor(Nut_precip[,c(15,16,18,23,24,20)],use='pairwise.complete.obs')
corrplot(res, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)

Avg<-Nut_precip%>%
  mutate(era=ifelse(year<1981,"1966-1980",
                    if_else(year<1991,"1981-1990",
                            if_else(year<2001,"1991-2000",
                                    if_else(year<2011,"2001-2010","2011-2022"
                    )))))%>%
  group_by(River_section,era)%>%
  summarise(TPx=mean(TP, na.rm = TRUE),
            TPsd=sd(TP, na.rm = TRUE),
            TNx=mean(TN, na.rm = TRUE),
            TNsd=sd(TN, na.rm = TRUE))
print(Avg)
```


###Kruskal Wallis on factors

```{r Kruskal Wallis for depth}
TP_aov<-aov(TP~NS_MC,data=Nut_precip)
plot(TP_aov)

kruskal.test(TN~NS_MC,data=Nut_precip)

group_by(Nut_precip, NS_MC) %>%
  summarise(
    meanTP = mean(TP, na.rm = TRUE),
    meanSRP = mean(SRP, na.rm = TRUE),
    medianTP = median(TP, na.rm = TRUE),
    medianSRP = median(SRP, na.rm = TRUE)
  )

p1<-ggplot(data=Nut_precip,aes(NS_MC,TN,fill=NS_MC))+geom_boxplot()+
  xlab("Depth")+
  ylab("TN (mg*L-1)") +
  scale_fill_viridis(discrete=TRUE)+
  scale_x_discrete(labels = c('Main Channel','Nearshore'))+
  theme(axis.title = element_text(size=15),panel.background = element_rect(fill="white"),axis.text = element_text(size=12),legend.position = "none")+
  geom_signif(comparisons = list(c("MC", "NS")), 
              map_signif_level=TRUE)
p1
ggsave("TN_depth_boxplot.svg",p1,dpi=600,width=10,height=8)

p2<-ggplot(data=Nut_precip,aes(NS_MC,TP,fill=NS_MC))+geom_boxplot()+
  xlab("Depth")+
  ylab("TP (ug*L-1)") +
  scale_fill_viridis(discrete=TRUE)+
  scale_x_discrete(labels = c('Main Channel','Nearshore'))+
  theme(axis.title = element_text(size=15),panel.background = element_rect(fill="white"),axis.text = element_text(size=12),legend.position = "none")+
  geom_signif(comparisons = list(c("MC", "NS")), 
              map_signif_level=TRUE)
p2
ggsave("TP_depth_boxplot.svg",p2,dpi=600,width=10,height=8)
```


```{r Kruskal Wallis for river section}
TP_aov<-aov(TP~River_section,data=Nut_precip)
plot(TP_aov)

TP_RS<-kruskal.test(TP~River_section,data=Nut_precip)
TP_RS
dunnTest(TP~River_section,data=spring)

p2<-ggplot(data=Nut_precip,aes(River_section,TP,fill=River_section))+geom_boxplot()+
  xlab("River Section")+
  scale_fill_viridis(discrete = TRUE,labels = c('Thousand Islands','Brockville Narrows','Lake St. Lawrence','Cornwall-Akwesasne','Lake St. Francis'))+
  ylab("TP (Âµg*L-1)") +
  labs(fill="River Section")+
  theme(axis.title.x = element_blank(),axis.title.y=element_text(size=14),
        axis.text = element_text(size=12),
        legend.position = "right",
        legend.text=element_text(size=12),
        legend.title=element_text(size=14),
        legend.key = element_rect(fill = "white"),
        panel.background = element_rect(fill="white"))#+
  #geom_signif(comparisons = list(c("BR", "LSF"),c("CA","LSF"),c("BR","TI"),c("LSF","TI")), 
   #           y_position = c(0.4,0.5,0.4,0.55),
    #          map_signif_level=TRUE)
p2
```

## Mann Kendall time series analysis

```{r Check linear model residuals for autocorrelation by dataset}
par(mar=c(3,3,3,0),mfrow=c(2,2))
datasets<-unique(Nut_precip$Data_source)
for (source in datasets) {
  mod<-lm(TP~year,data=subset(Nut_precip,Data_source==source))
acf(resid(mod),plot=T,main = paste("ACF Data_source", source),lag.max=35)
pacf(resid(mod),plot=T,main = paste("pACF Data_source", source),lag.max=35)
}
```
###Phosphorus 
```{r Seasonal Mann Kendall}
mod_raw<-lm(TP~year,data=Seas_Nut_TI)
par(mar=c(3,3,3,0),mfrow=c(2,2))
acf(resid(mod_raw),plot=T,main = paste("ACF Data_source"),lag.max=35)
pacf(resid(mod_raw),plot=T,main = paste("pACF Data_source"),lag.max=35)

Seas_Nut_LSF<-Nut_precip %>%# Specify original dataframe
  filter(River_section=="LSF"&year<2021)  %>%
  group_by(year,season) %>%   # Grouping variable(s)
  summarise(
    TP=mean(TP,na.rm=TRUE),
    TDP = mean(TDP,na.rm=TRUE),       
    SRP = mean(SRP,na.rm=TRUE),
    NH3.4 = mean(NH3.4,na.rm=TRUE),
    NO2.3 = mean(NO2.3,na.rm=TRUE),
    TN = mean(TN,na.rm=TRUE)
    )

SMKresultsP<-NULL
for(parameter in c("TP","SRP","TDP")){
P_SMK<-kendallSeasonalTrendTest(Seas_Nut_LSF[[parameter]]~season+year,
                            data=Seas_Nut_LSF,na.action=na.pass,
                            alternative="two.sided",
                            independent.obs=FALSE)

  SMKresultsP=rbind(SMKresultsP,data.frame(parameter,
                                           data.frame(as.list(P_SMK$estimate), 
                                                      as.list(P_SMK$p.value))))
}
write.table(SMKresultsP,"Seasonal Mann Kendall_P.txt",sep="\t")
SMKresultsP
```

#pscore test for breakpoints
```{r breakpoints}

icefree_nut_LSF<-Nut_precip %>% 
  filter(River_section=="LSF"&month>4&month<11)%>%# Specify original dataframe
  group_by(year) %>%   # Grouping variable(s)
  summarise(
    TP=mean(TP,na.rm=TRUE),
    TDP = mean(TDP,na.rm=TRUE),       
    SRP = mean(SRP,na.rm=TRUE),
    NH3.4 = mean(NH3.4,na.rm=TRUE),
    NO2.3 = mean(NO2.3,na.rm=TRUE),
    TN = mean(TN,na.rm=TRUE)
    )

for (parameter in c("TP","SRP")){
y<-icefree_nut_LSF[[parameter]]
x<-icefree_nut_LSF$year
break.value<-segmented(lm(y~x),seg.Z = ~x,psi = 2000)$psi[,2];break.value
seg.res<-segmented(lm(y~x),seg.Z = ~x,psi = 2000)
p1<-pscore.test(seg.res,seg.Z = ~x,k=10,alternative = c("two.sided"),
                values=NULL,dispersion=NULL,df.t=NULL,more.break=FALSE,n.break=1)
plot(seg.res,conf.level = 0.95,shade = TRUE,xlab="Year",ylab=paste(parameter , "ug*L-1"),
     ylim=c(0,0.1),xlim=c(1990,2022))
points(icefree_nut_LSF[[parameter]]~icefree_nut_LSF$year,pch=19)
lines(icefree_nut_LSF[[parameter]]~icefree_nut_LSF$year)
lines(seg.res,col=2,pch=19,lwd=2)
points(seg.res,col=4,link=FALSE)
abline(v=break.value,col="blue")
print(p1)
}
```

###Plot temporal P trends
LOESS plot of annual values
```{r N:P temporal plot}
Annual_nut<-Nut_precip%>%
  group_by(year, River_section)%>%
  summarise(TP=mean(TP,na.rm=TRUE),
            NP=mean(NP,na.rm=TRUE),
            NO3=mean(NO3,na.rm=TRUE),
            TN=mean(TN,na.rm=TRUE))

NP<-ggplot(Annual_nut, aes(year,NP)) +
  geom_point() +
  geom_smooth(method='gam',span=0.5)+
  xlab("Year")+
  ylab("N:P")+
    geom_hline(yintercept=29,color="orange",size=1,linetype="dashed")+
  theme_bw()
NP
ggsave("Plots/NP_Ratio_SLR.svg",NP,dpi=600,height=8,width=10)

mod_raw<-lm(NP~year,data=Annual_nut)
par(mfrow=c(1,2))
acf(resid(mod_raw),plot=T,main = paste("ACF Data_source"),lag.max=35)
pacf(resid(mod_raw),plot=T,main = paste("pACF Data_source"),lag.max=35)

NP_MK<-kendallTrendTest(NP~year,data=Annual_nut,na.action=na.pass,alternative="two.sided")
NP_MK$p.value
NP_MK$estimate

y<-Annual_nut$NP
x<-Annual_nut$year
break.value<-segmented(lm(y~x),seg.Z = ~x,psi = 2000)$psi[,2];break.value
seg.res<-segmented(lm(y~x),seg.Z = ~x,psi = 2000)
p1<-pscore.test(seg.res,seg.Z = ~x,k=10,alternative = c("two.sided"),values=NULL,dispersion=NULL,df.t=NULL,more.break=FALSE,n.break=1)
plot(seg.res,conf.level = 0.95,shade = TRUE,xlab="Year",ylab=paste("N:P"),
     xlim=c(1970,2022))
points(Annual_nut$NP~Annual_nut$year,pch=19)
lines(Annual_nut$NP~Annual_nut$year)
lines(seg.res,col=2,pch=19,lwd=2)
points(seg.res,col=4,link=FALSE)
abline(v=break.value,col="blue")
print(p1)

NP_gam<-gam(NP~s(year,bs='tp'),method="REML",
          family=tw(link="log"),data=Annual_nut)

k.check(NP_gam)
appraise(NP_gam)
par(mfrow=c(1,2))
acf(resid(NP_gam), lag.max = 36, main = "ACF")
pacf(resid(NP_gam), lag.max = 36, main = "pACF")
summary(NP_gam)

draw(NP_gam,select=1,residuals=FALSE)& theme_bw()

m2.d <- derivatives(NP_gam,term="s(year)",n=200)
m2.d<-m2.d%>%
  mutate(change=ifelse(upper<0,"dec",
                    if_else(lower>0,"inc","")
                    ))

sm_year <- smooth_estimates(NP_gam, smooth = "s(year)", dist = 0.05)
sm_year$upper<-sm_year$est+1.96*sm_year$se
sm_year$lower<-sm_year$est-1.96*sm_year$se

TP_year_plot<-ggplot(sm_year, aes(x=year,y=est))+
    geom_ribbon(alpha = 0.5,
              aes(ymin = lower, ymax = upper, fill = "confidence interval"))+
          annotate("rect",xmin=c(2009.543),
                    xmax=c(2016.613),
                    ymin=-Inf,ymax=Inf,fill="purple",alpha=0.2)+
  annotate("rect",xmin=c(1967.121,1992.035),
           xmax=c(1987.322,2004.492),
            ymin=-Inf,ymax=Inf,fill="orange",alpha=0.2)+
  geom_line(data = sm_year, aes(x=year,y=est,color = "GAM"),linewidth=1) +
  scale_fill_manual(values = "lightblue", name = NULL) +
  scale_color_manual(values = "blue", name = NULL) +
  ylab("Partial effect of year on N:P")+
  scale_x_continuous(name="Year",breaks=c(1970,1980,1990,2000,2010,2020))+
  theme_minimal(base_size = 16)+
  theme(legend.position="none")
TP_year_plot
```

###Nitrogen Mann Kendall

Seasonal Mann Kendall for NH3/4, NO2/3, and TN
```{r Seasonal Mann Kendall for N}
SMKresultsN<-NULL
for(parameter in c("TN","NO2.3","NH3.4"){
N_SMK<-kendallSeasonalTrendTest(Nut_precip[[parameter]]~season+year,
                                data=Nut_precip,na.action=na.pass,alternative="two.sided")

  SMKresultsN=rbind(SMKresultsN,data.frame(parameter,data.frame(as.list(N_SMK$estimate),
                                       as.list(N_SMK$p.value))))
}
write.table(SMKresultsN,"Seasonal Mann Kendall_N.txt",sep="\t")
SMKresultsN
```

pscore test to test for breakpoints
```{r N breakpoints}
for (parameter in c("TN","NO2.3","NH3.4")){
y<-Annual_Nut[[parameter]]
x<-Annual_Nut$year
break.value<-segmented(lm(y~x),seg.Z = ~x,psi = 2000)$psi[,2];break.value
seg.res<-segmented(lm(y~x),seg.Z = ~x,psi = 2000)
p1<-pscore.test(seg.res,seg.Z = ~x,k=10,alternative = c("two.sided"),values=NULL,dispersion=NULL,df.t=NULL,more.break=FALSE,n.break=1)
plot(seg.res,conf.level = 0.95,shade = TRUE,xlab="Year",ylab=paste(parameter , "mg*L-1"),
     ylim=c(0,1),xlim=c(1960,2022))
points(Annual_Nut[[parameter]]~Annual_Nut$year,pch=19)
lines(Annual_Nut[[parameter]]~Annual_Nut$year)
lines(seg.res,col=2,pch=19,lwd=2)
points(seg.res,col=4,link=FALSE)
abline(v=break.value,col="blue")
print(p1)
}
```

###Plot temporal N trends
LOESS N trends
```{r Seasonal N plots}
  for (parameter in c("TN","NO2.3","NH3.4")) {
print(ggplot(Annual_Nut, aes(year,Annual_Nut[[parameter]])) +
  geom_point() +
  geom_smooth(method='loess',span=0.5)+
  xlab("Year")+
  ylab(parameter)+
  theme_bw())
    }
```

##Let's Try GAMS

Data exploration
Histograms for each parameter
```{r Data exploration for GAMs}
for (parameter in c("TDP","TP","NH3.4","NO2.3","TN")) {
  hist(Nut_precip[[parameter]],main = paste("Histogram of" , parameter),xlab = parameter)
}
#all parameters left skewed
for (parameter in c("TDP","TP","NH3.4","NO2.3","TN")) {
#relationship exploration
print(ggplot(Nut_precip,aes(x=year,y=Nut_precip[[parameter]]))+geom_point()+
  ylab(parameter) )
print(ggplot(Nut_precip,aes(x=NS_MC,y=Nut_precip[[parameter]]))+geom_point()+
  ylab(parameter) )
print(ggplot(Nut_precip,aes(x=Total_Precip,y=Nut_precip[[parameter]]))+geom_point()+
  ylab(parameter) )
}
#Both year and river section need to be included in our model
```

Need to deal with autocorrelation
```{r Subset and autocorrelation checks}
#try models for different subsets of the data
spring<-Nut_precip %>%  
  filter(season=="spring"))

#spring_ag <- spring %>%                                   # Count non-NA values by group
#  group_by(Site,year,month,Longitude,Latitude,River_section,NS_MC,Total_Precip) %>%
#  dplyr::summarize(TPobs = sum(!is.na(TP),na.rm=TRUE),
#                   sd_TP = sd(TP, na.rm=TRUE),
#                   TP = mean(TP,na.rm=TRUE),
#                   TNobs = sum(!is.na(TN),na.rm=TRUE),
#                   sd_TN = sd(TN, na.rm=TRUE),
#                   TN = mean(TN,na.rm=TRUE)
#                    )

#check on basic model
M <- list(c(1, 0.5), NA)
TPM1<-gam(TP ~ s(year,m=2)+s(year,by=River_section,m=1)+ s(River_section,bs='re')+
            s(Data_source,bs='re')+
            s(DOY,bs="tp")+
            ti(year,DOY,bs='tp',m=c(1,0.5))+
            s(Longitude, Latitude,bs="ds",m=c(1,.5),k=10)+
            ti(Longitude,Latitude,year,d=c(2,1),bs=c('ds','tp'),m=c(1,0.5))+
            ti(Longitude,Latitude,DOY,d=c(2,1),bs=c('ds','tp'),m=c(1,0.5))+
            s(NS_MC,bs='re'),
              data=spring,method="REML",
          family=tw(link="log"))
k.check(TPM1)
appraise(TPM1)
par(mar=c(3,3,3,0),mfrow=c(2,2))
acf(resid(TPGI), lag.max = 36, main = "ACF")
pacf(resid(TPGI), lag.max = 36, main = "pACF")
summary(TPM1)

gam_errors <- residuals(TPM1, type = "response")
error_mod <- auto.arima(gam_errors)
error_mod
#check recommended order for AR (p) and/or MA (q)
checkresiduals(error_mod, theme = theme_bw())
#suggests p=4 for summer data

#add autoregressive moving average (ARMA)
TPM1_ARMA0<-gamm(TP ~ s(year,k=10, bs="tp")+ s(year,River_section,bs='fs')+ s(River_section,bs="re")+
            s(Data_source,bs="re")+
            s(DOY,bs="tp")+
            ti(year,DOY,bs='tp',m=c(1,0.5))+
            s(Longitude, Latitude,bs="ds",m=c(1,.5),k=15)+
            ti(Longitude,Latitude,year,d=c(2,1),bs=c('ds','tp'),m=c(1,0.5))+
            ti(Longitude,Latitude,DOY,d=c(2,1),bs=c('ds','tp'),m=c(1,0.5))+
            s(NS_MC,bs="re"), 
          data=spring,family='tw')

arma_res <- auto.arima(resid(TPM1_ARMA0$lme, type = "normalized"),
                       stationary = TRUE, seasonal = FALSE)
arma_res
#indicates summer model should be p=1, q=1

TPM1_ARMA<-gamm(TP ~ s(year,k=10, bs="tp")+ s(year,River_section,bs='fs')+ s(River_section,bs="re")+
            s(Data_source,bs="re")+
            s(DOY,bs="tp")+
            ti(year,DOY,bs='tp',m=c(1,0.5))+
            s(Longitude, Latitude,bs="ds",m=c(1,.5),k=15)+
            ti(Longitude,Latitude,year,d=c(2,1),bs=c('ds','tp'),m=c(1,0.5))+
            s(NS_MC,bs="re"),
          data=spring,  correlation = corARMA(form = ~1|year,p=1,q=1),
          family='tw')

appraise(TPM1_ARMA0$gam)
layout(matrix(1:2, ncol = 2))
res <- resid(TPM1_AR2$lme, type = "normalized")  #need to do on normalized resid
acf(res, lag.max = 36, main = "ACF - AR(1) errors")
pacf(res, lag.max = 36, main = "pACF- AR(1) errors")
layout(1)

anova(TPM1_ARMA0$lme,TPM1_AR1$lme,TPM1_AR2$lme)
```


###TP GAMs
```{r TP GAM building}
#factor-smooth interaction of year with river section
TPGI<-gam(TP ~ s(year,m=2) + s(year,by=River_section,m=1)+ s(River_section,bs='re')+
            s(Data_source,bs='re')+
            s(DOY,bs="tp")+
            s(NS_MC,bs='re')+
            s(Longitude, Latitude,bs="ds",m=c(1,.5),k=20)+
            ti(year,DOY,bs='tp',k=20)+
            ti(Longitude,Latitude,year,d=c(2,1),bs=c('ds','tp'),m = list(c(1, 0.5)),k=20)+
            ti(Longitude,Latitude,DOY,d=c(2,1),bs=c('ds','tp'),m = list(c(1, 0.5)),k=20),
              data=spring,method="REML",
          family=tw(link="log"))
gam.check(TPGI)

TPG_1<-gam(TP ~ s(year,bs='tp') +
            s(Data_source,bs='re')+
            s(DOY,bs="tp")+
            ti(year,DOY,bs='tp',k=20)+
            s(Longitude, Latitude,bs="ds",m=c(1,.5),k=20)+
            ti(Longitude,Latitude,year,d=c(2,1),bs=c('ds','tp'),m = list(c(1, 0.5)))+
            ti(Longitude,Latitude,DOY,d=c(2,1),bs=c('ds','tp'),m = list(c(1, 0.5)))+
            s(NS_MC,bs='re'),
              data=spring,method="REML",
          family=tw(link="log"))

#adding long and lat accounts for spatial structure of the data
TPGS<-gam(TP ~ s(year,m=2)+s(year,River_section,bs="fs",m=2)+
            s(Data_source,bs='re')+
            s(DOY,bs="tp")+
            ti(year,DOY,bs='tp',m=c(1,0.5))+
            s(Longitude, Latitude,bs="ds",m=c(1,.5),k=10)+
            ti(Longitude,Latitude,year,d=c(2,1),bs=c('ds','tp'),m = list(c(1, 0.5)))+
            ti(Longitude,Latitude,DOY,d=c(2,1),bs=c('ds','tp'),m = list(c(1, 0.5)))+
            s(NS_MC,bs='re'),
              data=spring,method="REML",
          family=tw(link="log"))
gam.check(TPM2)

TPS<-gam(TP ~ s(year,River_section,bs="fs",m=2)+
            s(Data_source,bs='re')+
            s(DOY,bs="tp")+
            ti(year,DOY,bs='tp',m=c(1,0.5))+
            s(Longitude, Latitude,bs="ds",m=c(1,.5),k=10)+
            ti(Longitude,Latitude,year,d=c(2,1),bs=c('ds','tp'),m=c(1,0.5))+
            ti(Longitude,Latitude,DOY,d=c(2,1),bs=c('ds','tp'),m=c(1,0.5))+
            s(NS_MC,bs='re'),
              data=spring,method="REML",
          family=tw(link="log"))
gam.check(TPM3)

TPI<-gam(TP ~ s(year,by=River_section,m=2)+ s(River_section,bs='re')+
            s(Data_source,bs='re')+
            s(DOY,bs="tp")+
            ti(year,DOY,bs='tp',k=20)+
            s(Longitude, Latitude,bs="ds",m=c(1,.5),k=50)+
            ti(Longitude,Latitude,year,d=c(2,1),bs=c('ds','tp'),m = list(c(1, 0.5)))+
            ti(Longitude,Latitude,DOY,d=c(2,1),bs=c('ds','tp'),m = list(c(1, 0.5)))+
            s(NS_MC,bs='re'),
             data=spring,method="REML",family=tw(link="log")))

gam.check(TPI)
TPI_1<-gam(TP ~ s(year,by=River_section,m=2)+ s(River_section,bs='re')+
            s(Data_source,bs='re')+
            s(DOY,bs="tp")+
            s(Longitude, Latitude,bs="ds",m=c(1,.5),k=10)+
            s(NS_MC,bs='re'),
              data=spring,method="REML",
          family=tw(link="log"))

#compare models
AIC(TPGI,TPGI_1,TPI,TPI_1)
summary(TPGI)
```


TP GAM model checking
```{r TP GAM checking}
#Basic diagnostics:
k.check(TPM1)
appraise(TPGI)

#Autocorrelation check:
par(mar=c(3,3,3,0),mfrow=c(2,2))
acf(resid(TPGI), lag.max = 36, main = "ACF")
pacf(resid(TPGI), lag.max = 36, main = "pACF")

#concurvity check:
concurvity(TPM1,full=TRUE)#if any of the values at worst are higher than 0.8, you want to look at full=FALSE as well.
concurvity(TPM2,full=FALSE)#Look for the worst-case scenario and see if variables with high values have problematic shapes or confidence intervals.
```

Plot TP GAM using gratia
```{r TP GAM plots}
#see all plots
draw(TPGI)

#Year partial effects at each river section 
draw(TPGI,select=1,residuals=FALSE)& theme_bw()
draw(TPGI,select=c(1:6),residuals=FALSE)& theme_bw()

#Year partial effects with long + lat
draw(TPG_1,select=6,residuals=FALSE,continuous_fill = ggplot2::scale_fill_distiller(palette = "PuOr", type = "div"))
draw(TPGI,select=13,residuals=TRUE,continuous_fill = ggplot2::scale_fill_distiller(palette = "PuOr", type = "div",na.value='transparent'))

#customized partial effect plots
p2 <- predict(TPGI, newdata = pdata,exclude=c("s(Data_source)"),newdata.guaranteed = TRUE)
m2.d <- derivatives(TPGI,term="s(year)",n=200)
m2.d<-m2.d%>%
  mutate(change=ifelse(upper<0,"dec",
                    if_else(lower>0,"inc","")
                    ))

sm_year <- smooth_estimates(TPGI, smooth = "s(year)", dist = 0.05)
sm_year$upper<-sm_year$est+1.96*sm_year$se
sm_year$lower<-sm_year$est-1.96*sm_year$se

TP_year_plot<-ggplot(sm_year, aes(x=year,y=est))+
    geom_ribbon(alpha = 0.5,
              aes(ymin = lower, ymax = upper, fill = "confidence interval"))+
  geom_line(data = sm_year, aes(x=year,y=est,color = "GAM"),linewidth=1) +
  scale_fill_manual(values = "lightblue", name = NULL) +
  scale_color_manual(values = "blue", name = NULL) +
  ylab("Partial effect of year on TP")+
  scale_x_continuous(name="Year",breaks=c(1970,1980,1990,2000,2010,2020))+
  theme_minimal(base_size = 16)+
  theme(legend.position="none")

TP_year_plot
ggsave("TP_year_plot.svg",TP_year_plot,width=12,height=8,dpi=600)

sm_year_TI <- smooth_estimates(TPGI, smooth = "s(year):River_sectionTI")
sm_year_TI$upper<-sm_year_TI$est+1.96*sm_year_TI$se
sm_year_TI$lower<-sm_year_TI$est-1.96*sm_year_TI$se

sm_year_TI<-sm_year_TI%>%
  mutate(sig=ifelse(upper<0|lower>0,"sig","ns"))

d_tp_TI <- derivatives(TPGI,term="s(year):River_sectionTI",n=200)
d_tp_TI<-d_tp_TI%>%
  mutate(change=ifelse(upper<0,"dec",
                    if_else(lower>0,"inc","")
                    ))

p_year_TI<-ggplot(sm_year_TI, aes(x=year,y=est))+
          annotate("rect",xmin=c(1975.201,1992.035),
                    xmax=c(1980.925,1995.739),
                    ymin=-Inf,ymax=Inf,fill="purple",alpha=0.2)+
  annotate("rect",xmin=c(1966.111,1984.291),
           xmax=c(1966.784,1987.995),
            ymin=-Inf,ymax=Inf,fill="orange",alpha=0.2)+
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = "confidence interval"),alpha = 0.5)+
  geom_line(data = sm_year_TI, aes(x=year,y=est,color = "GAM"),linewidth=1) +
  scale_fill_manual(values = "lightblue", name = NULL) +
  scale_color_manual(values = "darkblue", name = NULL) +
  ylab("Partial effect \n of year on TP")+
  scale_x_continuous(name="Year",breaks=c(1970,1980,1990,2000,2010,2020))+
  theme_minimal(base_size = 16)+
  theme(legend.position="none",
        axis.title.x = element_blank())

sm_year_BR <- smooth_estimates(TPGI, smooth = "s(year):River_sectionBR")
sm_year_BR$upper<-sm_year_BR$est+1.96*sm_year_BR$se
sm_year_BR$lower<-sm_year_BR$est-1.96*sm_year_BR$se

sm_year_BR<-sm_year_BR%>%
  mutate(sig=ifelse(upper<0|lower>0,"sig","ns"))

d_tp_BR <- derivatives(TPGI,term="s(year):River_sectionBR",n=200)
d_tp_BR<-d_tp_BR%>%
  mutate(change=ifelse(upper<0,"dec",
                    if_else(lower>0,"inc","")
                    ))

p_year_BR<-ggplot(sm_year_BR, aes(x=year,y=est))+
          annotate("rect",xmin=c(1976.211,1992.035),
                    xmax=c(1980.925,1992.709),
                    ymin=-Inf,ymax=Inf,fill="purple",alpha=0.2)+
  annotate("rect",xmin=c(1966.111,1999.106,2014.256),
           xmax=c(1970.824,2001.799,2017.960),
            ymin=-Inf,ymax=Inf,fill="orange",alpha=0.2)+
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = "confidence interval"),alpha = 0.5)+
  geom_line(data = sm_year_BR, aes(x=year,y=est,color = "GAM"),linewidth=1) +
  scale_fill_manual(values = "lightblue", name = NULL) +
  scale_color_manual(values = "darkblue", name = NULL) +
  ylab("Partial effect \n of year on TP")+
  scale_x_continuous(name="Year",breaks=c(1970,1980,1990,2000,2010,2020))+
  theme_minimal(base_size = 16)+
  theme(legend.position="none")

ggarrange(p_year_TI,p_year_BR,labels=c("A","B"),nrow=2,vjust=0.2)+
  theme(plot.margin = margin(10,1,1,1))

sm <- smooth_estimates(TPGI, smooth = "s(Longitude,Latitude)", dist = 0.05)
#ggplot(sm, aes(x = Longitude, y = Latitude)) +
#  geom_raster(aes(fill = est)) +
#  geom_point(data = spring, alpha = 0.2) + # add a point layer for original data
#  scale_fill_distiller(palette="PuOr",type="div",na.value="white")+
#  theme_minimal()

myMap <- get_stamenmap(bbox = c(left = -76.5969,
                                bottom = 44.00,
                                right = -74.00,
                                top = 45.25),
                       maptype = "terrain-background", 
                       crop = TRUE,
                       zoom = 9)

bbox <- c(left = -76.5969,bottom = 44.00,
          right = -74.00, top = 45.25)

register_google(key="AIzaSyDuPKc262hhKIryI6pH6Oa4XsQT2vMuiWo")
myMap <- get_googlemap(c(lon=-75.2, lat=44.8), zoom = 8, maptype = "satellite",
                         scale = 2)
myMap <- get_map(bbox, zoom = 8, maptype = "satellite",
                         scale = 2)

library(raster)
sm1<-as.data.frame(sm[,c(6:7,4)])
dfr <- rasterFromXYZ(sm1,crs="+datum=WGS84")
plot(dfr)
writeRaster(dfr,'TP_GAM.tif',overwrite=TRUE)

ggmap(myMap)+
  geom_raster(data=sm,mapping=aes(x=Longitude,y=Latitude,fill = est))+
  geom_point(data = spring,mapping=aes(x=Longitude,y=Latitude),alpha=0.1)+
  coord_cartesian() +
  scale_fill_distiller(palette="PuOr",type="div",na.value="transparent",name="Partial effect \n of location on TP")+
  xlab("Longitude")+
  ylab("Latitude")+
  theme(axis.title = element_text(size=15),axis.text = element_text(size=12),
        legend.key = element_rect(fill = "white"))

sm_ti <- smooth_estimates(TPGI, smooth = "ti(Longitude,Latitude,year)", dist = 0.1)
myYears<-c(1966,1970.525,1975.051,1980.141,1985.232,1990.323,
           1995.414,2000.505,2005.030,2010.121,2015.212,2020.303)
#need to line up with year values in sm
sm_abb <- filter(sm_ti, year %in% myYears)
spring_abb<-subset(spring,year==myYears)
ggmap(myMap)+
  geom_raster(data=sm_abb,mapping=aes(x=Longitude,y=Latitude,fill = est))+
  coord_cartesian() +
  scale_fill_distiller(palette="PuOr",type="div",na.value="transparent")+
  xlab("Longitude")+
  ylab("Latitude")+
  theme(axis.title = element_text(size=15),axis.text = element_text(size=12),
        legend.key = element_rect(fill = "white"))+
  facet_wrap(~year)
```

```{r Animated GAM results}

library(tidymv)
plot_smooths(TPGI,series=year,transform=exp)+theme1
pred <- get_gam_predictions(TPGI, year,transform = exp)

ggplot(pred, aes(year, TP))+
    geom_ribbon(alpha = 0.5,
              aes(ymin = CI_lower, ymax = CI_upper, fill = "confidence interval"))+
  geom_line(data = pred, aes(x=year,y=TP,color = "GAM"),linewidth=1) +
  scale_fill_manual(values = "lightblue", name = NULL) +
  scale_color_manual(values = "blue", name = NULL) +
  ylab("TP")+
  scale_x_continuous(name="Year",breaks=c(1970,1980,1990,2000,2010,2020))+
  theme_minimal(base_size = 16)+
  theme(legend.position="none")

pdata <- with(spring,
              expand.grid(DOY = median(DOY),
                          year = seq(min(year), max(year), by = 1),
                          Longitude = mean(TPGI$model$Longitude),
                          Latitude = mean(TPGI$model$Latitude)))

fit <- data.frame(predict.gam(TPGI,pdata,exclude=c("s(Data_source)","s(River_section)",
                                                   "s(NS_MC)",
                                        "s(year):River_sectionLSF","s(year):River_sectionCA",
                                        "s(year):River_sectionLSL","s(year):River_sectionBR",
                                        "s(year):River_sectionTI"),
                   newdata.guaranteed = TRUE, type = "response", se.fit = TRUE))

fit <- transform(fit, upper = fit + (1.96 * se.fit), lower = fit - (1.96 * se.fit))
pred <- cbind(pdata, fit)
predabb<-subset(pred,year>=1965)

ggplot(predabb, aes(year, fit))+
    geom_ribbon(alpha = 0.5,
              aes(ymin = lower, ymax = upper, fill = "confidence interval"))+
  geom_line(data = predabb, aes(x=year,y=fit,color = "GAM"),linewidth=1) +
  scale_fill_manual(values = "lightblue", name = NULL) +
  scale_color_manual(values = "blue", name = NULL) +
  ylab("TP")+
  scale_x_continuous(name="Year",breaks=c(1970,1980,1990,2000,2010,2020))+
  theme_minimal(base_size = 16)+
  theme(legend.position="none")

num_years <- max(spring$year) - min(spring$year) + 1

myyears <- c(1966,1968,1970,1972,1974,1976,1978,1980,1982,1984,1986,1988,1990,1992,
             1994,1996,1998,2000,2002,2004,2006,2008,2010,2012,2014,2016,2018,2020,2022)

predabb<-subset(pred,year==myyears)

ggplot(predabb, aes(x = Longitude, y = Latitude)) +
    geom_raster(aes(fill = Fitted)) + facet_wrap(~ year, ncol = 10) +
    scale_fill_viridis(name = "TP", option = 'plasma',
                       na.value = 'transparent') +
    coord_quickmap() +
    theme(legend.position = 'top', legend.key.width = unit(2, 'cm'))

p <- ggplot(pred, aes(x = Longitude, y = Latitude)) +
    geom_raster(aes(fill = Fitted)) +
    scale_fill_viridis(name = "TP (ug/L)", option = 'plasma',
                       na.value = 'transparent') +
    coord_quickmap()+
  ggtitle('Year: {frame_time}') +
    theme(legend.position = 'top', legend.key.width = unit(2, 'cm'))+
    labs(x = 'Longitude', y = 'Latitude')+
  transition_time(year)

animate(p,nframes = num_years,fps=2,width = 500, height = 365,
        renderer = gifski_renderer(), res = 200)

ggplot(fit, aes(x = year, y = fitted)) +
  geom_ribbon(aes(ymin = lwr_ci, ymax = upr_ci), alpha = 0.2) +
  geom_line()
```

###TN GAMs
```{r TN GAM model building}
#Try base model
TNM1<-gam(TN ~ s(year,k=20,m=2, bs="tp")+ s(year, by = River_section,m=1)+ s(River_section,bs='re')+
            s(Data_source,bs='re')+
            s(DOY,bs="tp")+
            s(Longitude, Latitude,bs="ds",m=c(1,.5),k=10)+
            s(NS_MC,bs='re')+
            s(Total_Precip,k=15),
              data=spring,method="REML",
          family=tw(link="log"))
k.check(TNM1)
appraise(TNM1)
par(mar=c(3,3,3,0),mfrow=c(2,2))
acf(resid(TNM1), lag.max = 36, main = "ACF")
pacf(resid(TNM1), lag.max = 36, main = "pACF")
summary(TNM1)

#check if need to account for autocorrelation or moving average
gam_errors <- residuals(TNM1, type = "response")
error_mod <- auto.arima(gam_errors)
error_mod
#check recommended order for AR (p) and/or MA (q)
checkresiduals(error_mod, theme = theme_bw())
#suggests p=4 for summer data

#add autoregressive moving average (ARMA)
TNM1_ARMA0<-gamm(TN ~ s(year,k=10, bs="tp")+ s(year,River_section,bs='fs')+ s(River_section,bs="re")+
            s(Data_source,bs='re')+
            s(DOY,bs="tp")+
            s(Longitude, Latitude,bs="ds",m=c(1,.5),k=10)+
            s(NS_MC,bs='re'), 
          data=spring,family='tw')

auto.arima(resid(TNM1_ARMA0$lme, type = "normalized"),
                       stationary = TRUE, seasonal = FALSE)

#indicates summer model should be p=1, q=3
TNM1_AR1<-gamm(TN ~ s(year,k=10, bs="tp")+ s(year,River_section,bs='fs')+ s(River_section,bs="re")+
            s(Data_source,bs="re")+
            s(DOY,bs="tp")+
            s(Longitude, Latitude,bs="ds",m=c(1,.5),k=10)+
            s(NS_MC,bs="re"),
          data=spring,  correlation = corARMA(form = ~1|year,p=1,q=3),
          family='tw')

appraise(TNM1_AR1$gam)
layout(matrix(1:2, ncol = 2))
res <- resid(TNM1_AR1$lme, type = "normalized")  #need to do on normalized resid
acf(res, lag.max = 36, main = "ACF - AR(1) errors")
pacf(res, lag.max = 36, main = "pACF- AR(1) errors")
layout(1)

anova(TNM1_ARMA0$lme,TNM1_AR1$lme)
```


```{r TN GAM building}
#factor-smooth interaction of year with river section
TNM1<-gam(TN ~ s(year,k=10,m=2, bs="tp")+ s(year, by = River_section,m=1)+ s(River_section,bs='re')+
            s(Data_source,bs='re')+
            s(DOY,bs="tp")+
            s(Longitude, Latitude,bs="ds",m=c(1,.5),k=10)+
            s(NS_MC,bs='re'),
            data=spring,method="REML",
          family=tw(link="log"))
gam.check(TNM1)

#adding long and lat accounts for spatial structure of the data
TNM2<-gam(TN ~ s(year,k=10,m=2, bs="tp")+ s(year, by = River_section,m=1)+ s(River_section,bs='re')+
            s(Data_source,bs='re')+
            s(DOY,bs="tp")+
            s(Longitude, Latitude,bs="ds",m=c(1,.5),k=10)+
            s(NS_MC,bs='re')+
            s(Total_Precip), 
            data=spring,method="REML",family=tw(link="log"))
gam.check(TNM2)

TN_GS<-gam(TN ~ s(year,m=2)+s(year,River_section,bs="fs",m=2)+
            s(Data_source,bs='re')+
            s(DOY,bs="tp")+
            s(Longitude, Latitude,bs="ds",m=c(1,.5),k=10)+
            s(NS_MC,bs='re')+
            s(Total_Precip), 
            data=spring,method="REML",family=tw(link="log"))

TN_S<-gam(TN ~ s(year,River_section,bs="fs",m=2)+
            s(Data_source,bs='re')+
            s(DOY,bs="tp")+
            s(Longitude, Latitude,bs="ds",m=c(1,.5),k=10)+
            s(NS_MC,bs='re')+
            s(Total_Precip), 
            data=spring,method="REML",family=tw(link="log"))

TNI<-gam(TN ~ s(year, by = River_section)+
            s(Data_source,bs='re')+
            s(DOY,bs="tp")+
            s(Longitude, Latitude,bs="ds",m=c(1,.5),k=10)+
            s(NS_MC,bs='re')+
           s(Total_Precip),
            data=spring,method="REML",
          family=tw(link="log"))

TN_G<-gam(TN ~ s(year,k=10, bs="tp")+
            s(Data_source,bs='re')+
            s(DOY,bs="tp")+
            s(Longitude, Latitude,bs="ds",m=c(1,.5),k=10)+
            s(NS_MC,bs='re')+
            s(Total_Precip),
            data=spring,method="REML",
          family=tw(link="log"))

#compare models
AIC(TNM1,TNM2,TN_GS,TN_S,TNI,TN_G)
summary(TNM2)
```

TN GAM model checking
```{r TN GAM checking}
#Basic diagnostics:
k.check(TNM4)
appraise(TNM2)

#Autocorrelation check:
par(mar=c(3,3,3,0),mfrow=c(2,2))
acf(resid(TNM2), lag.max = 36, main = "ACF")
pacf(resid(TNM2), lag.max = 36, main = "pACF")

#concurvity check:
concurvity(TNM4,full=TRUE)#if any of the values at worst are higher than 0.8, you want to look at full=FALSE as well.
concurvity(TPM2,full=FALSE)#Look for the worst-case scenario and see if variables with high values have problematic shapes or confidence intervals.
```

Plot TN GAM using gratia
```{r TN GAM plots}
#see all plots
draw(TNM3)

#Year partial effects at each river section 
draw(TNM2,select=c(1:5),residuals=FALSE) & theme_bw()

#Year partial effects with long + lat
draw(TNM2,select=9,residuals=TRUE,continuous_fill = ggplot2::scale_fill_distiller(palette = "PuOr",
                                                     type = "div")) &
  theme_bw()

#Precipitation partial effects 
draw(TNI,select=9,residuals=FALSE)& theme_bw()
draw(TNM2,select=11,residuals=FALSE)& theme_bw()

tn_sm_year <- smooth_estimates(TNM2, smooth = "s(year)", dist = 0.05)
tn_sm_year$upper<-tn_sm_year$est+1.96*tn_sm_year$se
tn_sm_year$lower<-tn_sm_year$est-1.96*tn_sm_year$se

tn_sm_year<-tn_sm_year%>%
  mutate(sig=ifelse(upper<0|lower>0,"sig","ns"))

d_tn <- derivatives(TNM2,term="s(year)",n=200)
d_tn <-d_tn%>%
  mutate(change=ifelse(upper<0,"dec",
                    if_else(lower>0,"inc","")
                    ))

ggplot(tn_sm_year, aes(x=year,y=est))+
          annotate("rect",xmin=c(2006.176),
                    xmax=c(2022.00),
                    ymin=-Inf,ymax=Inf,fill="purple",alpha=0.2)+
  annotate("rect",xmin=c(1990.015),
           xmax=c(1995.065),
            ymin=-Inf,ymax=Inf,fill="orange",alpha=0.2)+
    geom_ribbon(alpha = 0.5,
              aes(ymin = lower, ymax = upper, fill = "confidence interval"))+
  geom_line(data = tn_sm_year, aes(x=year,y=est,color = "GAM"),linewidth=1) +
  scale_fill_manual(values = "lightblue", name = NULL) +
  scale_color_manual(values = "darkblue", name = NULL) +
  ylab("Partial effect of year on TN")+
  scale_x_continuous(name="Year",breaks=c(1970,1980,1990,2000,2010,2020))+
  theme_minimal(base_size = 16)+
  theme(legend.position="none")

tn_sm_year_TI <- smooth_estimates(TNM2, smooth = "s(year):River_sectionTI", dist = 0.05)
tn_sm_year_TI$upper<-tn_sm_year_TI$est+1.96*tn_sm_year_TI$se
tn_sm_year_TI$lower<-tn_sm_year_TI$est-1.96*tn_sm_year_TI$se

d_tn_TI <- derivatives(TNM2,term="s(year):River_sectionTI",n=200)
d_tn_TI <-d_tn_TI%>%
  mutate(change=ifelse(upper<0,"dec",
                    if_else(lower>0,"inc","")
                    ))
#no significant changes

t_year_TI<-ggplot(tn_sm_year_TI, aes(x=year,y=est))+
    geom_ribbon(alpha = 0.5,
              aes(ymin = lower, ymax = upper, fill = "confidence interval"))+
  geom_line(data = tn_sm_year_TI, aes(x=year,y=est,color = "GAM"),linewidth=1) +
  scale_fill_manual(values = "lightblue", name = NULL) +
  scale_color_manual(values = "darkblue", name = NULL) +
  ylab("Partial effect")+
  scale_x_continuous(name="Year",breaks=c(1970,1980,1990,2000,2010,2020))+
  theme_minimal(base_size = 16)+
  theme(legend.position="none")

tn_sm_year_BR <- smooth_estimates(TNM2, smooth = "s(year):River_sectionBR", dist = 0.05)
tn_sm_year_BR$upper<-tn_sm_year_BR$est+1.96*tn_sm_year_BR$se
tn_sm_year_BR$lower<-tn_sm_year_BR$est-1.96*tn_sm_year_BR$se

d_tn_BR <- derivatives(TNM2,term="s(year):River_sectionBR",n=200)
d_tn_BR <-d_tn_BR%>%
  mutate(change=ifelse(upper<0,"dec",
                    if_else(lower>0,"inc","")
                    ))
#no significant changes

t_year_BR<-ggplot(tn_sm_year_BR, aes(x=year,y=est))+
    geom_ribbon(alpha = 0.5,
              aes(ymin = lower, ymax = upper, fill = "confidence interval"))+
  geom_line(data = tn_sm_year_BR, aes(x=year,y=est,color = "GAM"),linewidth=1) +
  scale_fill_manual(values = "lightblue", name = NULL) +
  scale_color_manual(values = "darkblue", name = NULL) +
  ylab("Partial effect")+
  scale_x_continuous(name="Year",breaks=c(1970,1980,1990,2000,2010,2020))+
  theme_minimal(base_size = 16)+
  theme(legend.position="none")

tn_sm_year_CA <- smooth_estimates(TNM2, smooth = "s(year):River_sectionCA", dist = 0.05)
tn_sm_year_CA$upper<-tn_sm_year_CA$est+1.96*tn_sm_year_CA$se
tn_sm_year_CA$lower<-tn_sm_year_CA$est-1.96*tn_sm_year_CA$se

d_tn_CA <- derivatives(TNM2,term="s(year):River_sectionCA",n=200)
d_tn_CA <-d_tn_CA%>%
  mutate(change=ifelse(upper<0,"dec",
                    if_else(lower>0,"inc","")
                    ))

t_year_CA<-ggplot(tn_sm_year_CA, aes(x=year,y=est))+
          annotate("rect",xmin=c(1986.312),
                    xmax=c(1991.698),
                    ymin=-Inf,ymax=Inf,fill="purple",alpha=0.2)+
          annotate("rect",xmin=c(1976.211),
           xmax=c(1981.935),
            ymin=-Inf,ymax=Inf,fill="orange",alpha=0.2)+
    geom_ribbon(alpha = 0.5,
              aes(ymin = lower, ymax = upper, fill = "confidence interval"))+
  geom_line(data = tn_sm_year_CA, aes(x=year,y=est,color = "GAM"),linewidth=1) +
  scale_fill_manual(values = "lightblue", name = NULL) +
  scale_color_manual(values = "darkblue", name = NULL) +
  ylab("Partial effect \n of year on TN")+
  scale_x_continuous(name="Year",breaks=c(1970,1980,1990,2000,2010,2020))+
  theme_minimal(base_size = 16)+
  theme(legend.position="none")

tn_sm_year_LSF <- smooth_estimates(TNM2, smooth = "s(year):River_sectionLSF", dist = 0.05)
tn_sm_year_LSF$upper<-tn_sm_year_LSF$est+1.96*tn_sm_year_LSF$se
tn_sm_year_LSF$lower<-tn_sm_year_LSF$est-1.96*tn_sm_year_LSF$se

d_tn_LSF <- derivatives(TNM2,term="s(year):River_sectionLSF",n=200)
d_tn_LSF<-d_tn_LSF%>%
  mutate(change=ifelse(upper<0,"dec",
                    if_else(lower>0,"inc","")
                    ))

t_year_LSF<-ggplot(tn_sm_year_LSF, aes(x=year,y=est))+
          annotate("rect",xmin=c(2002.136),
                    xmax=c(2003.819),
                    ymin=-Inf,ymax=Inf,fill="purple",alpha=0.2)+
          annotate("rect",xmin=c(2008.196),
           xmax=c(2013.920),
            ymin=-Inf,ymax=Inf,fill="orange",alpha=0.2)+
    geom_ribbon(alpha = 0.5,
              aes(ymin = lower, ymax = upper, fill = "confidence interval"))+
  geom_line(data = tn_sm_year_LSF, aes(x=year,y=est,color = "GAM"),linewidth=1) +
  scale_fill_manual(values = "lightblue", name = NULL) +
  scale_color_manual(values = "darkblue", name = NULL) +
  ylab("Partial effect \n of year on TN")+
  scale_x_continuous(name="Year",breaks=c(1970,1980,1990,2000,2010,2020))+
  theme_minimal(base_size = 16)+
  theme(legend.position="none")

ggarrange(t_year_CA,t_year_LSF,labels=c("A","B"), nrow=2,vjust=0.2)+
  theme(plot.margin = margin(10,1,1,1))

sm_precip <- smooth_estimates(TNM2, smooth = "s(Total_Precip)", dist = 0.05)
sm_precip$upper<-sm_precip$est+1.96*sm_precip$se
sm_precip$lower<-sm_precip$est-1.96*sm_precip$se

sm_precip<-sm_precip%>%
  mutate(sig=ifelse(upper<0|lower>0,"sig","ns"))

d_tn_precip <- derivatives(TNM2,term="s(Total_Precip)",n=200)
d_tn_precip <-d_tn_precip%>%
  mutate(change=ifelse(upper<0,"dec",
                    if_else(lower>0,"inc","")
                    ))

TN_precip_plot<-ggplot(sm_precip, aes(x=Total_Precip,y=est))+
          annotate("rect",xmin=c(10.400),
           xmax=c(66.48643),
            ymin=-Inf,ymax=Inf,fill="orange",alpha=0.2)+
    geom_ribbon(alpha = 0.5,
              aes(ymin = lower, ymax = upper, fill = "confidence interval"))+
  geom_line(data = sm_precip, aes(x=Total_Precip,y=est,color = "GAM"),linewidth=1) +
  scale_fill_manual(values = "lightblue", name = NULL) +
  scale_color_manual(values = "darkblue", name = NULL) +
  ylab("Partial effect of precipitation on TN")+
  scale_x_continuous(name="Precipitation")+
  theme_minimal(base_size = 16)+
  theme(legend.position="none")
ggsave("TN_precip_plot.svg",TN_precip_plot,width=12,height=8,dpi=600)
```


##Water Quality Interactions
TP and CHLA
```{r CHLA~TP relationship}
lm1<-lm(log1p(CHLA)~log1p(TP),data=Ac_gov)
summary(lm1)

p1<-ggplot(data=Ac_gov,aes(log1p(TP),log1p(CHLA)))+geom_point()
p1<-p1 +geom_smooth(method=lm,color="blue",fill="#69b3a2", se=TRUE)+
  theme(axis.title = element_text(size=15),panel.background = element_rect(fill="white"))+
  xlab("Log TP (mg*L-1)")+
  ylab("Log Chl a (ug*L-1)")
p1
```

TSS and TP
```{r TP~TSS relationship}
lm1<-glm(TP~TSS,data=Nut_precip,family=Gamma(link="log"))
summary(lm1)
par(mfrow=c(2,2))
plot(lm1)

p2<-ggplot(data=Ac_gov,aes(TSS,TP))+geom_point()
p2<-p2 +geom_smooth(method=lm,color="blue",fill="#69b3a2", se=TRUE)+
  theme(axis.title = element_text(size=15),panel.background = element_rect(fill="white"))+
  xlab("TSS (mg*L-1)")+
  ylab("TP (ug*L-1)")+
  xlim(0,450)+
  stat_cor(aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")),label.x=200,label.y=0.4)
  
p2
```

##Invasive Dreissenid impacts

```{r pre/post dreissenid analysis}
#select stations with pre and post invasion data, limit to ice-free season (may-oct) within 10 years of invasion (1991)
icefree<-Ac_gov %>%                  # Specify original dataframe
  filter(month > 4,month<11&Site=="20170010"|Site=="20180011") %>%     # Filter condition
  group_by(Site,year,River_section,Longitude,Latitude,month) %>%   # Grouping variable(s)
  summarise(
    CHLA = mean(CHLA,na.rm=TRUE),
    TDP = mean(TDP),       # calculate mean of column var in my.df
    SRP = mean(SRP,na.rm=TRUE),         
    TP = mean(TP,na.rm=TRUE),
    NH3.4 = mean(NH3.4),
    NO2.3 = mean(NO2.3),
    TN = mean(TN)
    )

icefree <- icefree %>% 
  mutate(invade = if_else(year < 1991, "pre", "post"))
icefree$invade<-factor(icefree$invade,levels=c('pre','post'))

icefree <- icefree %>% 
  mutate(chltp = CHLA/(TP*1000))

icefree$lchltp<-log1p(icefree$chltp)

king<-subset(icefree,River_section=="TI"&year<2001&year>1980)
brock<-subset(icefree,River_section=="BR"&year<2001&year>1980)

MW_king<-wilcox.test(lchltp~invade,data=king)
MW_king
pairwise.wilcox.test(king$lchltp, king$year,
                 p.adjust.method = "BH")

MW_brock<-wilcox.test(lchltp~invade,data=brock)
MW_brock
pairwise.wilcox.test(brock$lchltp, brock$year,
                 p.adjust.method = "BH")

lm1<-lm(log1p(CHLA)~log1p(TP),data=subset(king,invade=="pre"))
summary(lm1)
plot(lm1)

lm2<-lm(log1p(CHLA)~log1p(TP),data=subset(king,invade=="post"))
summary(lm2)
plot(lm2)

lm3<-lm(log1p(CHLA)~log1p(TP),data=subset(brock,invade=="pre"))
summary(lm3)
plot(lm3)

lm4<-lm(log1p(CHLA)~log1p(TP),data=subset(brock,invade=="post"))
summary(lm4)
plot(lm4)
```

```{r dreissenid anaylsis plots}
theme1<-theme(axis.title.x = element_blank(),axis.title.y=element_text(size=14),axis.text = element_text(size=12),legend.position = "none",legend.title=element_text(size=14),legend.key = element_rect(fill = "white"),legend.text=element_text(size=12),panel.background = element_rect(fill="white"))

p1<-ggplot(data=king,aes(invade,lchltp,fill=invade))+geom_boxplot()+
  ylab("Log Chla: Log TP") +
  scale_fill_viridis(discrete=TRUE,labels=c("Pre-invasion","Post-invasion"))+
  labs(fill="Invasion Status")+
  scale_x_discrete(labels = c('Pre','Post'))+
  ylim(0,0.75)+
  geom_signif(comparisons = list(c("pre", "post")), 
              map_signif_level=TRUE,y_position=0.6)+
  theme1+
  ggtitle("Kingston")

p2<-ggplot(data=brock,aes(invade,lchltp,fill=invade))+geom_boxplot()+
   scale_fill_viridis(discrete=TRUE,labels=c("Pre-invasion","Post-invasion"))+
  labs(fill="Invasion Status")+
  scale_x_discrete(labels = c('Pre','Post'))+
  ylim(0,0.75)+
  geom_signif(comparisons = list(c("pre", "post")), 
              map_signif_level=TRUE,y_position=0.6)+
  theme1+
  ggtitle("Brockville")


chl.tp_plot<-ggarrange(p1,p2+ rremove("ylab"), nrow=1,common.legend = TRUE,legend = "right")
ggsave("chla.tp_boxplot.svg",chl.tp_plot,width=12,height=8,dpi=600)


p4<-ggplot(data=king,aes(log1p(TP*1000),log1p(CHLA)))+geom_point()
p4<-p4 +geom_smooth(method=lm,color="blue",fill="#69b3a2", se=TRUE)+
  theme(axis.title = element_text(size=15),panel.background = element_rect(fill="white"))+
  xlab("log TP (ug*L-1)")+
  ylab("log Chla (ug*L-1)")+
  ylim(0,3.5)+
  ggtitle("Kingston")
p4<-p4 + facet_grid(. ~ invade)

p5<-ggplot(data=brock,aes(log1p(TP*1000),log1p(CHLA)))+geom_point()
p5<-p5 +geom_smooth(method=lm,color="blue",fill="#69b3a2", se=TRUE)+
  theme(axis.title = element_text(size=15),panel.background = element_rect(fill="white"))+
  xlab("log TP (ug*L-1)")+
  ylab("log Chla (ug*L-1)")+
  ylim(0,3.5)+
  ggtitle("Brockville")
p5<-p5 + facet_grid(. ~ invade)

ggarrange(p1,p2+ rremove("ylab"),p4+ rremove("ylab"),p5,ncol=2,common.legend = TRUE)
```

```{r Annual trends}
uslr<-icefree %>% 
  filter(year<2001&year>1980)%>% 
    group_by(year,Site,Longitude,Latitude,River_section) %>%   # Grouping variable(s)
  summarise(
    CHLA = mean(CHLA),
    TDP = mean(TDP),       # calculate mean of column var in my.df
    SRP = mean(SRP),         
    TP = mean(TP),
    NH3.4 = mean(NH3.4),
    NO2.3 = mean(NO2.3),
    TN = mean(TN),
    lchltp=mean(lchltp,na.rm=TRUE)
    )


p5<-ggplot(data=uslr,aes(year,lchltp,color=River_section))+geom_point()
p5<-p5 +geom_smooth(method=loess,se=TRUE)+
  theme(axis.title = element_text(size=15),panel.background = element_rect(fill="white"))+
  xlab("Year")+
  ylab("Log Chla:TP")+
  geom_vline(xintercept=1990,color="red",size=1,linetype=5)
p5
```

